/*
------------------------------------------
@Author: Sliverkiss
@Date: 2024.04.25 12:34:33
@Description:å¾®ä¿¡è¯»ä¹¦app ç‚¹å‡»è®¢é˜…äººæ•°, è§£é”ä¸‹æž¶ä¹¦ç±ã€‚
@Thanks:æ„Ÿè°¢æ°´å›ã€@leepyerç­‰äººæä¾›çš„å¤§åŠ›å¸®åŠ©ã€‚è¯¥è„šæœ¬ä»…ä¾›å­¦ä¹ ç ”ç©¶ï¼Œè¯·å‹¿ç”¨äºŽéžæ³•ç”¨é€”ã€‚
------------------------------------------
[Script]
http-request ^https:\/\/i\.weread\.qq\.com\/subscription\/users\?bookId=.+ script-path=https://raw.githubusercontent.com/axtyet/Nebula/main/QuantumultX/scripts/WxRead/wxread.js, requires-body=true, timeout=60, tag=å¾®ä¿¡è¯»ä¹¦èŽ·å–ä¹¦ç±

[MITM]
hostname = i.weread.qq.com
*/
const $=new Env("å¾®ä¿¡é˜…è¯»èŽ·å–ä¹¦ç±");
//prettier-ignore
async function addReview(e){try{const t={url:"https://i.weread.qq.com/review/add",type:"post",dataType:"json",headers:{...$request.headers,cookie:"wr_logined=1"},body:{isPrivate:1,bookId:e,content:"æŽ¨èé˜…è¯»",star:null,type:null,bookVersion:null}};let s=await Request(t);return $.log("[INFO][addReview]"),$.log(JSON.stringify(s)),s?.reviewId}catch(e){$.log(e)}}async function deleteReview(e){try{const t={url:"https://i.weread.qq.com/review/delete",type:"post",dataType:"json",headers:{...$request.headers,cookie:"wr_logined=1"},body:{reviewId:e}};let s=await Request(t);$.log("[INFO][deleteReview]"),$.log(JSON.stringify(s)),$.log("")}catch(e){$.log(e)}}async function addBook(e){try{const t={url:"https://i.weread.qq.com/shelf/add",type:"post",dataType:"json",headers:{...$request.headers,cookie:"wr_logined=1"},body:{bookIds:[e]}};let s=await Request(t);return $.log("[INFO][addBook]"),$.log(JSON.stringify(s)),$.log(""),s}catch(e){$.log(e)}}async function chapterdownload(e){try{const t={url:`https://i.weread.qq.com/book/chapterdownload?bookId=${e}&bookType=txt&bookVersion=0&chapters=1&modernVersion=8.1.0.22&pf=weread_wx-2001-iap-2001-iphone&pfkey=pfkey&preload=2&release=1&screenSize=16x9&synckey=&zoneId=1`,type:"post",dataType:"json",headers:{...$request.headers,cookie:"wr_logined=1"},body:{bookIds:[e]}};let s=await Request(t);$.log("[INFO][chapterdownload]"),$.log($.toStr($.toObj(s)||{msg:"chapterdownload loading success!"}))}catch(e){$.log(e)}}function getQueries(e){const[,t]=e.split("?");return t?t.split("&").reduce(((e,t)=>{var[s,t]=t.split("=");return e[s]=t,e}),{}):{}}async function Request(e){"string"==typeof e&&(e={url:e});try{if(!e?.url)throw new Error("[URL][ERROR] ç¼ºå°‘ url å‚æ•°");let{url:t,type:s,headers:o={},body:r,params:i,dataType:a="form",resultType:n="data"}=e;const h=s?s?.toLowerCase():"body"in e?"post":"get",l=t.concat("post"===h?"?"+$.queryStr(i):""),d=e.timeout?$.isSurge()?e.timeout/1e3:e.timeout:1e4;"json"===a&&(o["Content-Type"]="application/json;charset=UTF-8");const c="string"==typeof r?r:r&&"form"==a?$.queryStr(r):$.toStr(r),u={...e,...e?.opts?e.opts:{},url:l,headers:o,..."post"===h&&{body:c},..."get"===h&&i&&{params:i},timeout:d},g=$.http[h.toLowerCase()](u).then((e=>"data"==n?$.toObj(e.body)||e.body:$.toObj(e)||e)).catch((e=>$.log(`[${h.toUpperCase()}][ERROR] ${e}\n`)));return Promise.race([new Promise(((e,t)=>setTimeout((()=>t("å½“å‰è¯·æ±‚å·²è¶…æ—¶")),d))),g])}catch(e){console.log(`[${p.toUpperCase()}][ERROR] ${e}\n`)}}function Env(e,t){class s{constructor(e){this.env=e}send(e,t="GET"){e="string"==typeof e?{url:e}:e;let s=this.get;return"POST"===t&&(s=this.post),new Promise(((t,o)=>{s.call(this,e,((e,s,r)=>{e?o(e):t(s)}))}))}get(e){return this.send.call(this.env,e)}post(e){return this.send.call(this.env,e,"POST")}}return new class{constructor(e,t){this.logLevels={debug:0,info:1,warn:2,error:3},this.logLevelPrefixs={debug:"[DEBUG] ",info:"[INFO] ",warn:"[WARN] ",error:"[ERROR] "},this.logLevel="info",this.name=e,this.http=new s(this),this.data=null,this.dataFile="box.dat",this.logs=[],this.isMute=!1,this.isNeedRewrite=!1,this.logSeparator="\n",this.encoding="utf-8",this.startTime=(new Date).getTime(),Object.assign(this,t),this.log("",`ðŸ””${this.name}, å¼€å§‹!`)}getEnv(){return"undefined"!=typeof $environment&&$environment["surge-version"]?"Surge":"undefined"!=typeof $environment&&$environment["stash-version"]?"Stash":"undefined"!=typeof module&&module.exports?"Node.js":"undefined"!=typeof $task?"Quantumult X":"undefined"!=typeof $loon?"Loon":"undefined"!=typeof $rocket?"Shadowrocket":void 0}isNode(){return"Node.js"===this.getEnv()}isQuanX(){return"Quantumult X"===this.getEnv()}isSurge(){return"Surge"===this.getEnv()}isLoon(){return"Loon"===this.getEnv()}isShadowrocket(){return"Shadowrocket"===this.getEnv()}isStash(){return"Stash"===this.getEnv()}toObj(e,t=null){try{return JSON.parse(e)}catch{return t}}toStr(e,t=null,...s){try{return JSON.stringify(e,...s)}catch{return t}}getjson(e,t){let s=t;if(this.getdata(e))try{s=JSON.parse(this.getdata(e))}catch{}return s}setjson(e,t){try{return this.setdata(JSON.stringify(e),t)}catch{return!1}}getScript(e){return new Promise((t=>{this.get({url:e},((e,s,o)=>t(o)))}))}runScript(e,t){return new Promise((s=>{let o=this.getdata("@chavy_boxjs_userCfgs.httpapi");o=o?o.replace(/\n/g,"").trim():o;let r=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout");r=r?1*r:20,r=t&&t.timeout?t.timeout:r;const[i,a]=o.split("@"),n={url:`http://${a}/v1/scripting/evaluate`,body:{script_text:e,mock_type:"cron",timeout:r},headers:{"X-Key":i,Accept:"*/*"},timeout:r};this.post(n,((e,t,o)=>s(o)))})).catch((e=>this.logErr(e)))}loaddata(){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const e=this.path.resolve(this.dataFile),t=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(e),o=!s&&this.fs.existsSync(t);if(!s&&!o)return{};{const o=s?e:t;try{return JSON.parse(this.fs.readFileSync(o))}catch(e){return{}}}}}writedata(){if(this.isNode()){this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const e=this.path.resolve(this.dataFile),t=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(e),o=!s&&this.fs.existsSync(t),r=JSON.stringify(this.data);s?this.fs.writeFileSync(e,r):o?this.fs.writeFileSync(t,r):this.fs.writeFileSync(e,r)}}lodash_get(e,t,s){const o=t.replace(/\[(\d+)\]/g,".$1").split(".");let r=e;for(const e of o)if(r=Object(r)[e],void 0===r)return s;return r}lodash_set(e,t,s){return Object(e)!==e||(Array.isArray(t)||(t=t.toString().match(/[^.[\]]+/g)||[]),t.slice(0,-1).reduce(((e,s,o)=>Object(e[s])===e[s]?e[s]:e[s]=Math.abs(t[o+1])>>0==+t[o+1]?[]:{}),e)[t[t.length-1]]=s),e}getdata(e){let t=this.getval(e);if(/^@/.test(e)){const[,s,o]=/^@(.*?)\.(.*?)$/.exec(e),r=s?this.getval(s):"";if(r)try{const e=JSON.parse(r);t=e?this.lodash_get(e,o,""):t}catch(e){t=""}}return t}setdata(e,t){let s=!1;if(/^@/.test(t)){const[,o,r]=/^@(.*?)\.(.*?)$/.exec(t),i=this.getval(o),a=o?"null"===i?null:i||"{}":"{}";try{const t=JSON.parse(a);this.lodash_set(t,r,e),s=this.setval(JSON.stringify(t),o)}catch(t){const i={};this.lodash_set(i,r,e),s=this.setval(JSON.stringify(i),o)}}else s=this.setval(e,t);return s}getval(e){switch(this.getEnv()){case"Surge":case"Loon":case"Stash":case"Shadowrocket":return $persistentStore.read(e);case"Quantumult X":return $prefs.valueForKey(e);case"Node.js":return this.data=this.loaddata(),this.data[e];default:return this.data&&this.data[e]||null}}setval(e,t){switch(this.getEnv()){case"Surge":case"Loon":case"Stash":case"Shadowrocket":return $persistentStore.write(e,t);case"Quantumult X":return $prefs.setValueForKey(e,t);case"Node.js":return this.data=this.loaddata(),this.data[t]=e,this.writedata(),!0;default:return this.data&&this.data[t]||null}}initGotEnv(e){this.got=this.got?this.got:require("got"),this.cktough=this.cktough?this.cktough:require("tough-cookie"),this.ckjar=this.ckjar?this.ckjar:new this.cktough.CookieJar,e&&(e.headers=e.headers?e.headers:{},e&&(e.headers=e.headers?e.headers:{},void 0===e.headers.cookie&&void 0===e.headers.Cookie&&void 0===e.cookieJar&&(e.cookieJar=this.ckjar)))}get(e,t=(()=>{})){switch(e.headers&&(delete e.headers["Content-Type"],delete e.headers["Content-Length"],delete e.headers["content-type"],delete e.headers["content-length"]),e.params&&(e.url+="?"+this.queryStr(e.params)),void 0===e.followRedirect||e.followRedirect||((this.isSurge()||this.isLoon())&&(e["auto-redirect"]=!1),this.isQuanX()&&(e.opts?e.opts.redirection=!1:e.opts={redirection:!1})),this.getEnv()){case"Surge":case"Loon":case"Stash":case"Shadowrocket":default:this.isSurge()&&this.isNeedRewrite&&(e.headers=e.headers||{},Object.assign(e.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.get(e,((e,s,o)=>{!e&&s&&(s.body=o,s.statusCode=s.status?s.status:s.statusCode,s.status=s.statusCode),t(e,s,o)}));break;case"Quantumult X":this.isNeedRewrite&&(e.opts=e.opts||{},Object.assign(e.opts,{hints:!1})),$task.fetch(e).then((e=>{const{statusCode:s,statusCode:o,headers:r,body:i,bodyBytes:a}=e;t(null,{status:s,statusCode:o,headers:r,body:i,bodyBytes:a},i,a)}),(e=>t(e&&e.error||"UndefinedError")));break;case"Node.js":let s=require("iconv-lite");this.initGotEnv(e),this.got(e).on("redirect",((e,t)=>{try{if(e.headers["set-cookie"]){const s=e.headers["set-cookie"].map(this.cktough.Cookie.parse).toString();s&&this.ckjar.setCookieSync(s,null),t.cookieJar=this.ckjar}}catch(e){this.logErr(e)}})).then((e=>{const{statusCode:o,statusCode:r,headers:i,rawBody:a}=e,n=s.decode(a,this.encoding);t(null,{status:o,statusCode:r,headers:i,rawBody:a,body:n},n)}),(e=>{const{message:o,response:r}=e;t(o,r,r&&s.decode(r.rawBody,this.encoding))}))}}post(e,t=(()=>{})){const s=e.method?e.method.toLocaleLowerCase():"post";switch(e.body&&e.headers&&!e.headers["Content-Type"]&&!e.headers["content-type"]&&(e.headers["content-type"]="application/x-www-form-urlencoded"),e.headers&&(delete e.headers["Content-Length"],delete e.headers["content-length"]),void 0===e.followRedirect||e.followRedirect||((this.isSurge()||this.isLoon())&&(e["auto-redirect"]=!1),this.isQuanX()&&(e.opts?e.opts.redirection=!1:e.opts={redirection:!1})),this.getEnv()){case"Surge":case"Loon":case"Stash":case"Shadowrocket":default:this.isSurge()&&this.isNeedRewrite&&(e.headers=e.headers||{},Object.assign(e.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient[s](e,((e,s,o)=>{!e&&s&&(s.body=o,s.statusCode=s.status?s.status:s.statusCode,s.status=s.statusCode),t(e,s,o)}));break;case"Quantumult X":e.method=s,this.isNeedRewrite&&(e.opts=e.opts||{},Object.assign(e.opts,{hints:!1})),$task.fetch(e).then((e=>{const{statusCode:s,statusCode:o,headers:r,body:i,bodyBytes:a}=e;t(null,{status:s,statusCode:o,headers:r,body:i,bodyBytes:a},i,a)}),(e=>t(e&&e.error||"UndefinedError")));break;case"Node.js":let o=require("iconv-lite");this.initGotEnv(e);const{url:r,...i}=e;this.got[s](r,i).then((e=>{const{statusCode:s,statusCode:r,headers:i,rawBody:a}=e,n=o.decode(a,this.encoding);t(null,{status:s,statusCode:r,headers:i,rawBody:a,body:n},n)}),(e=>{const{message:s,response:r}=e;t(s,r,r&&o.decode(r.rawBody,this.encoding))}))}}time(e,t=null){const s=t?new Date(t):new Date;let o={"M+":s.getMonth()+1,"d+":s.getDate(),"H+":s.getHours(),"m+":s.getMinutes(),"s+":s.getSeconds(),"q+":Math.floor((s.getMonth()+3)/3),S:s.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(s.getFullYear()+"").substr(4-RegExp.$1.length)));for(let t in o)new RegExp("("+t+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?o[t]:("00"+o[t]).substr((""+o[t]).length)));return e}queryStr(e){let t="";for(const s in e){let o=e[s];null!=o&&""!==o&&("object"==typeof o&&(o=JSON.stringify(o)),t+=`${s}=${o}&`)}return t=t.substring(0,t.length-1),t}msg(t=e,s="",o="",r={}){const i=e=>{const{$open:t,$copy:s,$media:o,$mediaMime:r}=e;switch(typeof e){case void 0:return e;case"string":switch(this.getEnv()){case"Surge":case"Stash":default:return{url:e};case"Loon":case"Shadowrocket":return e;case"Quantumult X":return{"open-url":e};case"Node.js":return}case"object":switch(this.getEnv()){case"Surge":case"Stash":case"Shadowrocket":default:{const i={};let a=e.openUrl||e.url||e["open-url"]||t;a&&Object.assign(i,{action:"open-url",url:a});let n=e["update-pasteboard"]||e.updatePasteboard||s;if(n&&Object.assign(i,{action:"clipboard",text:n}),o){let e,t,s;if(o.startsWith("http"))e=o;else if(o.startsWith("data:")){const[e]=o.split(";"),[,r]=o.split(",");t=r,s=e.replace("data:","")}else t=o,s=(e=>{const t={JVBERi0:"application/pdf",R0lGODdh:"image/gif",R0lGODlh:"image/gif",iVBORw0KGgo:"image/png","/9j/":"image/jpg"};for(var s in t)if(0===e.indexOf(s))return t[s];return null})(o);Object.assign(i,{"media-url":e,"media-base64":t,"media-base64-mime":r??s})}return Object.assign(i,{"auto-dismiss":e["auto-dismiss"],sound:e.sound}),i}case"Loon":{const s={};let r=e.openUrl||e.url||e["open-url"]||t;r&&Object.assign(s,{openUrl:r});let i=e.mediaUrl||e["media-url"];return o?.startsWith("http")&&(i=o),i&&Object.assign(s,{mediaUrl:i}),console.log(JSON.stringify(s)),s}case"Quantumult X":{const r={};let i=e["open-url"]||e.url||e.openUrl||t;i&&Object.assign(r,{"open-url":i});let a=e["media-url"]||e.mediaUrl;o?.startsWith("http")&&(a=o),a&&Object.assign(r,{"media-url":a});let n=e["update-pasteboard"]||e.updatePasteboard||s;return n&&Object.assign(r,{"update-pasteboard":n}),console.log(JSON.stringify(r)),r}case"Node.js":return}default:return}};if(!this.isMute)switch(this.getEnv()){case"Surge":case"Loon":case"Stash":case"Shadowrocket":default:$notification.post(t,s,o,i(r));break;case"Quantumult X":$notify(t,s,o,i(r));case"Node.js":}if(!this.isMuteLog){let e=["","==============ðŸ“£ç³»ç»Ÿé€šçŸ¥ðŸ“£=============="];e.push(t),s&&e.push(s),o&&e.push(o),console.log(e.join("\n")),this.logs=this.logs.concat(e)}}debug(...e){this.logLevels[this.logLevel]<=this.logLevels.debug&&(e.length>0&&(this.logs=[...this.logs,...e]),console.log(`${this.logLevelPrefixs.debug}${e.map((e=>e??String(e))).join(this.logSeparator)}`))}info(...e){this.logLevels[this.logLevel]<=this.logLevels.info&&(e.length>0&&(this.logs=[...this.logs,...e]),console.log(`${this.logLevelPrefixs.info}${e.map((e=>e??String(e))).join(this.logSeparator)}`))}warn(...e){this.logLevels[this.logLevel]<=this.logLevels.warn&&(e.length>0&&(this.logs=[...this.logs,...e]),console.log(`${this.logLevelPrefixs.warn}${e.map((e=>e??String(e))).join(this.logSeparator)}`))}error(...e){this.logLevels[this.logLevel]<=this.logLevels.error&&(e.length>0&&(this.logs=[...this.logs,...e]),console.log(`${this.logLevelPrefixs.error}${e.map((e=>e??String(e))).join(this.logSeparator)}`))}log(...e){e.length>0&&(this.logs=[...this.logs,...e]),console.log(e.map((e=>e??String(e))).join(this.logSeparator))}logErr(e,t){switch(this.getEnv()){case"Surge":case"Loon":case"Stash":case"Shadowrocket":case"Quantumult X":default:this.log("",`â—ï¸${this.name}, é”™è¯¯!`,t,e);break;case"Node.js":this.log("",`â—ï¸${this.name}, é”™è¯¯!`,t,void 0!==e.message?e.message:e,e.stack)}}wait(e){return new Promise((t=>setTimeout(t,e)))}done(e={}){const t=((new Date).getTime()-this.startTime)/1e3;switch(this.log("",`ðŸ””${this.name}, ç»“æŸ! ðŸ•› ${t} ç§’`),this.log(),this.getEnv()){case"Surge":case"Loon":case"Stash":case"Shadowrocket":case"Quantumult X":default:$done(e);break;case"Node.js":process.exit(1)}}}(e,t)}(async()=>{try{const e=getQueries($request.url)?.bookId;let t=await addReview(e);await chapterdownload(e);let s=await addBook(e);await deleteReview(t),s?.succ?$.msg($.name,"ðŸŽ‰ æ·»åŠ ä¹¦ç±æˆåŠŸ,åˆ‡æ¢é¡µé¢å³å¯é£Ÿç”¨ï¼",$.notifyMsg):$.msg($.name,"âŒ æ·»åŠ ä¹¦ç±å¤±è´¥,è¯·å°è¯•å…¶å®ƒä¹¦ç±ï¼",JSON.stringify(s))}catch(e){throw e}})().catch((e=>{$.logErr(e),$.msg($.name,"â›”ï¸ script run error!",e.message||e)})).finally((async()=>{$.done({ok:1})}));
